<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Kalshi Config</title>
    <style>
      :root {
        color-scheme: dark;
        font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont, "Roboto", sans-serif;
      }

      body {
        margin: 0;
        min-height: 100vh;
        background: #020617;
        color: #f8fafc;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 2rem 1rem;
      }

      main {
        width: 100%;
        max-width: 520px;
        background: rgba(15, 23, 42, 0.9);
        border: 1px solid rgba(148, 163, 184, 0.25);
        border-radius: 1.25rem;
        padding: 2rem;
        box-shadow: 0 60px 120px rgba(2, 6, 23, 0.8);
        display: flex;
        flex-direction: column;
        gap: 1.25rem;
      }

      h1 {
        margin: 0;
        font-size: 1.6rem;
      }

      form {
        display: flex;
        flex-direction: column;
        gap: 1rem;
      }

      label {
        display: flex;
        flex-direction: column;
        gap: 0.35rem;
        font-size: 0.9rem;
      }

      input[type="text"],
      input[type="number"],
      input[type="url"] {
        border-radius: 0.8rem;
        border: 1px solid rgba(148, 163, 184, 0.35);
        background: rgba(2, 6, 23, 0.85);
        padding: 0.75rem 0.9rem;
        font-size: 0.95rem;
        color: inherit;
      }

      .toggle {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 0.75rem 0.9rem;
        border-radius: 0.9rem;
        border: 1px solid rgba(148, 163, 184, 0.3);
        background: rgba(2, 6, 23, 0.6);
      }

      .grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
      }

      button {
        border: none;
        border-radius: 0.9rem;
        padding: 0.85rem 1rem;
        font-size: 1rem;
        font-weight: 600;
        background: linear-gradient(120deg, #34d399, #22d3ee);
        color: #0f172a;
      }

      .status {
        font-size: 0.85rem;
        min-height: 1.4rem;
      }

      pre {
        background: rgba(2, 6, 23, 0.8);
        border: 1px solid rgba(148, 163, 184, 0.25);
        border-radius: 0.9rem;
        padding: 0.75rem;
        white-space: pre-wrap;
        max-height: 320px;
        overflow: auto;
      }
    </style>
  </head>
  <body>
    <main>
      <section>
        <h1>Kalshi Module</h1>
        <p>Configure how control signals map to Kalshi moneyline orders.</p>
      </section>
      <form id="configForm">
        <label>
          Relay server URL (fixed)
          <input type="url" id="serverUrl" required placeholder="https://jester.fly.dev" value="https://jester.fly.dev" readonly />
        </label>
        <label>
          Access token (optional; must match server ACCESS_TOKEN)
          <input type="password" id="tokenInput" placeholder="shared secret" />
        </label>
        <label class="toggle">
          <input type="checkbox" id="enabled" />
          Enable trading module
        </label>
        <label>
          Event slug (full Kalshi event ticker, e.g., KXNBAGAME-25DEC12ATLDET)
          <input type="text" id="slug" placeholder="KXNBAGAME-25DEC12ATLDET" />
        </label>
        <div class="grid">
          <label>
            Home ticker suffix (e.g., ORL)
            <input type="text" id="homeSuffix" placeholder="ORL" />
          </label>
          <label>
            Away ticker suffix (e.g., NYK)
            <input type="text" id="awaySuffix" placeholder="NYK" />
          </label>
        </div>
        <label>
          Bet unit size (contracts per press)
          <input type="number" id="betUnitSize" min="1" step="1" value="1" />
        </label>
        <label class="toggle">
          <input type="checkbox" id="testMode" />
          Run in test mode (log requests without sending to Kalshi)
        </label>
        <label class="toggle">
          <input type="checkbox" id="moneylineEnabled" checked />
          Enable moneyline bets
        </label>
        <label class="toggle">
          <input type="checkbox" id="spreadEnabled" />
          Enable spread bets (choose spread priced near 40-60)
        </label>
        <button type="submit">Save settings</button>
        <div class="status" id="status"></div>
      </form>
      <section id="testSection" hidden>
        <h2>Test mode events</h2>
        <p>Logged requests appear below when test mode is enabled.</p>
        <div style="display: flex; gap: 0.5rem; flex-wrap: wrap">
          <button type="button" id="refreshLog">Refresh log</button>
          <button type="button" id="clearLog">Clear log</button>
        </div>
        <pre id="logOutput">No events yet.</pre>
      </section>
      <section id="liveSection">
        <h2>Live orders</h2>
        <p>Recent real orders (non-test), including rejection bodies.</p>
        <div style="display: flex; gap: 0.5rem; flex-wrap: wrap">
          <button type="button" id="refreshLive">Refresh live log</button>
          <button type="button" id="clearLive">Clear live log</button>
        </div>
        <pre id="liveOutput">No live events yet.</pre>
      </section>
    </main>
    <script>
      const DEFAULT_SERVER = 'https://jester.fly.dev';
      const STORAGE_KEY = 'jester-kalshi-server';
      const serverInput = document.querySelector('#serverUrl');
      const tokenInput = document.querySelector('#tokenInput');
      const form = document.querySelector('#configForm');
      const statusEl = document.querySelector('#status');

      const enabledInput = document.querySelector('#enabled');
      const slugInput = document.querySelector('#slug');
      const homeSuffixInput = document.querySelector('#homeSuffix');
      const awaySuffixInput = document.querySelector('#awaySuffix');
      const unitInput = document.querySelector('#betUnitSize');
      const testModeInput = document.querySelector('#testMode');
      const moneylineEnabledInput = document.querySelector('#moneylineEnabled');
      const spreadEnabledInput = document.querySelector('#spreadEnabled');

      const testSection = document.querySelector('#testSection');
      const logOutput = document.querySelector('#logOutput');
      const refreshBtn = document.querySelector('#refreshLog');
      const clearBtn = document.querySelector('#clearLog');
      const liveOutput = document.querySelector('#liveOutput');
      const liveRefreshBtn = document.querySelector('#refreshLive');
      const liveClearBtn = document.querySelector('#clearLive');

      const savedToken = localStorage.getItem(`${STORAGE_KEY}-token`);
      serverInput.value = DEFAULT_SERVER;
      if (savedToken) {
        tokenInput.value = savedToken;
      }
      fetchConfig(DEFAULT_SERVER);

      form.addEventListener('submit', (event) => {
        event.preventDefault();
        const base = DEFAULT_SERVER;
        const token = tokenInput.value.trim();

        localStorage.setItem(`${STORAGE_KEY}-token`, token);
        const payload = {
          enabled: enabledInput.checked,
          slug: slugInput.value,
          homeSuffix: homeSuffixInput.value,
          awaySuffix: awaySuffixInput.value,
          betUnitSize: Number(unitInput.value) || 1,
          moneylineEnabled: moneylineEnabledInput.checked,
          spreadEnabled: spreadEnabledInput.checked,
          testMode: testModeInput.checked
        };

        const tokenParam = token ? `?token=${encodeURIComponent(token)}` : '';
        fetch(`${base.replace(/\/$/, '')}/config/kalshi${tokenParam}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        })
          .then((res) => {
            if (!res.ok) {
              throw new Error('Unable to save settings');
            }
            return res.json();
          })
          .then((data) => {
            populateForm(data);
            setStatus('Settings saved successfully');
            maybeFetchLogs();
          })
          .catch((err) => {
            setStatus(err.message || 'Failed to save settings', true);
          });
      });

      function fetchConfig(baseUrl) {
        const token = tokenInput.value.trim();
        const tokenParam = token ? `?token=${encodeURIComponent(token)}` : '';
        fetch(`${baseUrl.replace(/\/$/, '')}/config/kalshi${tokenParam}`)
          .then((res) => {
            if (!res.ok) {
              throw new Error('Unable to load settings');
            }
            return res.json();
          })
          .then((data) => {
            populateForm(data);
            setStatus('Settings loaded');
            maybeFetchLogs();
          })
          .catch((err) => {
            setStatus(err.message || 'Failed to load settings', true);
          });
      }

      function populateForm(config) {
        enabledInput.checked = !!config.enabled;
        slugInput.value = config.slug ?? '';
        homeSuffixInput.value = config.homeSuffix ?? '';
        awaySuffixInput.value = config.awaySuffix ?? '';
        unitInput.value = config.betUnitSize ?? 1;
        testModeInput.checked = !!config.testMode;
        moneylineEnabledInput.checked = config.moneylineEnabled ?? true;
        spreadEnabledInput.checked = config.spreadEnabled ?? false;
        testSection.hidden = !testModeInput.checked;
      }

      function setStatus(message, isError = false) {
        statusEl.textContent = message;
        statusEl.style.color = isError ? '#f87171' : '#a5f3fc';
      }

      function maybeFetchLogs() {
        testSection.hidden = !testModeInput.checked;
        refreshTestLog();
        refreshLiveLog();
      }

      function refreshTestLog() {
        if (!testModeInput.checked) {
          logOutput.textContent = 'Test mode is off.';
          return;
        }
        const base = DEFAULT_SERVER;
        const token = tokenInput.value.trim();
        const tokenParam = token ? `?token=${encodeURIComponent(token)}` : '';
        fetch(`${base.replace(/\/$/, '')}/config/kalshi/test${tokenParam}`)
          .then((res) => res.json())
          .then((data) => {
            const events = data.events ?? [];
            if (!events.length) {
              logOutput.textContent = 'No test events logged yet.';
              return;
            }
            logOutput.textContent = events
              .map((evt) => {
                const when = new Date(evt.at).toLocaleTimeString();
                const body = evt.body ? JSON.stringify(evt.body, null, 2) : '';
                const header = `${when} ${evt.side?.toUpperCase?.() ?? ''} ${evt.count} @ ${evt.ticker}`;
                return body ? `${header}\n${body}` : header;
              })
              .join('\n\n');
          })
          .catch(() => {
            logOutput.textContent = 'Unable to load test events.';
          });
      }

      function clearTestLog() {
        const base = DEFAULT_SERVER;
        const token = tokenInput.value.trim();
        const tokenParam = token ? `?token=${encodeURIComponent(token)}` : '';
        fetch(`${base.replace(/\/$/, '')}/config/kalshi/test${tokenParam}`, { method: 'DELETE' }).then(() => {
          logOutput.textContent = 'Log cleared.';
        });
      }

      function refreshLiveLog() {
        const base = DEFAULT_SERVER;
        const token = tokenInput.value.trim();
        const tokenParam = token ? `?token=${encodeURIComponent(token)}` : '';
        fetch(`${base.replace(/\/$/, '')}/config/kalshi/live${tokenParam}`)
          .then((res) => res.json())
          .then((data) => {
            const events = data.events ?? [];
            if (!events.length) {
              liveOutput.textContent = 'No live events logged yet.';
              return;
            }
            liveOutput.textContent = events
              .map((evt) => {
                const when = new Date(evt.at).toLocaleTimeString();
                const status = evt.status ? ` status=${evt.status}` : '';
                const note = evt.note ? ` note=${evt.note}` : '';
                const err = evt.error ? ` error=${evt.error}` : '';
                const body = evt.responseBody ? `\n${evt.responseBody}` : '';
                const count = evt.count ? ` count=${evt.count}` : '';
                const details = evt.details ? `\ndetails: ${JSON.stringify(evt.details, null, 2)}` : '';
                return `${when} ${evt.kind?.toUpperCase?.() ?? ''} ${evt.side?.toUpperCase?.() ?? ''} @ ${evt.ticker ?? 'unknown'}${count}${status}${note}${err}${body}${details}`;
              })
              .join('\n\n');
          })
          .catch(() => {
            liveOutput.textContent = 'Unable to load live events.';
          });
      }


      function clearLiveLog() {
        const base = DEFAULT_SERVER;
        const token = tokenInput.value.trim();
        const tokenParam = token ? `?token=${encodeURIComponent(token)}` : '';
        fetch(`${base.replace(/\/$/, '')}/config/kalshi/live${tokenParam}`, { method: 'DELETE' }).then(() => {
          liveOutput.textContent = 'Log cleared.';
        });
      }

      refreshBtn.addEventListener('click', refreshTestLog);
      clearBtn.addEventListener('click', clearTestLog);
      liveRefreshBtn.addEventListener('click', refreshLiveLog);
      liveClearBtn.addEventListener('click', clearLiveLog);
      testModeInput.addEventListener('change', maybeFetchLogs);
      refreshLiveLog();
    </script>
  </body>
</html>
